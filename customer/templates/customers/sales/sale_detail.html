{% extends 'index.html' %}
{% load static %}
{% load humanize %}
{% block content %}
    {% include "partials/spinner.html" with id="body_spinner" %}
    <div class="flex flex-col h-full" id="main_body">
        <div class="flex flex-row h-full">
            <!-- ========================== -->
            <!-- SIDEBAR: SALES LIST        -->
            <!-- ========================== -->
            {% block _side_bar %}
                <div x-data="{ activeSale: '{{ sale.pk }}' }"
                     class="flex-none w-[360px] h-screen bg-white border-r flex flex-col z-20">
                    <!-- Sidebar Header -->
                    <div class="flex-none border-b">
                        <div class="h-16 flex items-center justify-between px-4 py-2">
                            <h4 class="text-gray-900 text-lg font-medium">All Sales</h4>
                            <!-- Add New Sale Button -->
                            <a href="{% url 'customers' %}"
                               class="px-2 py-1 text-sm font-medium text-center text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors"
                               title="Go to Customers to create sale">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     viewBox="0 0 20 20"
                                     fill="currentColor"
                                     class="size-5">
                                    <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
                                </svg>
                            </a>
                        </div>
                    </div>
                    <!-- Sidebar List Content -->
                    {% block side_bar_list %}
                        <div id="sidebar_pagination" class="flex-1 flex flex-col min-h-0">
                            <div id="side_bar" class="flex-1 overflow-y-auto min-h-0">
                                {% for s in sale_list %}
                                    <a href="{% url 'sale_detail' pk=s.pk %}"
                                       class="h-18 flex flex-col justify-center px-5 border-b hover:bg-gray-50 transition-colors duration-150 py-3"
                                       hx-boost="true"
                                       hx-target="#main_content"
                                       hx-indicator="#side_bar_spinner"
                                       @click="activeSale = '{{ s.pk }}'"
                                       x-bind:class="{'bg-blue-50 border-r-4 border-r-blue-600': activeSale === '{{ s.pk }}' }">
                                        <div class="flex justify-between items-center w-full mb-1">
                                            <h4 class="text-gray-800 font-medium text-sm truncate w-40">{{ s.customer.full_name|upper }}</h4>
                                            <span class="text-xs font-mono text-gray-500">{{ s.sale_number }}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <p class="text-xs text-gray-500">{{ s.sale_date | date:"M d, Y" }}</p>
                                            {% if s.status == 'voided' %}
                                                <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-red-100 text-red-600">Voided</span>
                                            {% else %}
                                                <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-green-100 text-green-700">Active</span>
                                            {% endif %}
                                        </div>
                                    </a>
                                {% empty %}
                                    <div class="p-5 text-center text-gray-500 text-sm">No sales records found.</div>
                                {% endfor %}
                            </div>
                            <!-- Sidebar Pagination -->
                            <div class="flex-none sticky bottom-0 bg-white border-t border-gray-200 p-2 z-10">
                                <div class="flex justify-end">
                                    {% include "partials/pagination.html" with page_obj=sale_list target="sidebar_pagination" %}
                                </div>
                            </div>
                        </div>
                    {% endblock side_bar_list %}
                </div>
            {% endblock _side_bar %}
            <!-- ========================== -->
            <!-- MAIN CONTENT: DETAIL VIEW  -->
            <!-- ========================== -->
            <div class="flex-1 bg-white relative flex flex-col h-screen overflow-hidden"
                 id="content-wrapper">
                {% include "partials/spinner.html" with id="side_bar_spinner" %}
                <div id="main_content" class="flex-1 flex flex-col overflow-hidden">
                    {% block main_content %}
                        {% if sale %}
                            <!-- Top Header Toolbar -->
                            {% block _header %}
                                <div class="flex-none bg-white py-3 px-6 h-16 border-b flex justify-between items-center z-10">
                                    <div>
                                        <h1 class="text-lg font-bold text-gray-900">{{ sale.sale_number }}</h1>
                                        <p class="text-xs text-gray-500">Created by {{ sale.created_by.get_full_name|default:sale.created_by.username }}</p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <!-- Back Button -->
                                        <button onclick="history.back()"
                                                class="text-gray-400 hover:text-gray-600 transition-colors p-1">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 fill="none"
                                                 viewBox="0 0 24 24"
                                                 stroke-width="1.5"
                                                 stroke="currentColor"
                                                 class="size-6">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            {% endblock _header %}
                            <!-- Scrollable Invoice Area -->
                            {% block _content %}
                                <div id="_content" class="flex-1 overflow-y-auto bg-gray-50 p-6">
                                    <!-- Invoice Card -->
                                    <div class="bg-white shadow-sm border border-gray-200 rounded-lg max-w-5xl mx-auto min-h-[600px]">
                                        <!-- Invoice Header -->
                                        <div class="flex justify-between items-start p-8 border-b border-gray-100">
                                            <div>
                                                <h1 class="text-2xl font-bold text-gray-900 mb-1">SALE RECEIPT</h1>
                                                <p class="text-sm text-gray-500">{{ sale.sale_date|date:"l, F j, Y" }}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Customer</p>
                                                <p class="text-lg font-medium text-blue-600 hover:underline">
                                                    <a href="{% url 'customer_detail' sale.customer.pk %}"
                                                       hx-boost="true"
                                                       hx-target="#main_body"
                                                       hx-indicator="#body_spinner">{{ sale.customer.full_name|upper }}</a>
                                                </p>
                                                <p class="text-sm text-gray-600">{{ sale.customer.phone }}</p>
                                            </div>
                                        </div>
                                        <!-- Status Grid -->
                                        <div class="p-8 border-b border-gray-100 bg-gray-50/50">
                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                                                <div>
                                                    <p class="text-xs text-gray-500 uppercase font-medium mb-1">Status</p>
                                                    {% if sale.status == 'active' %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                            ACTIVE
                                                        </span>
                                                    {% else %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                            VOIDED
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <p class="text-xs text-gray-500 uppercase font-medium mb-1">Payment Method</p>
                                                    <span class="text-sm font-medium text-gray-900 capitalize flex items-center gap-1">
                                                        {{ sale.get_payment_method_display|upper }}
                                                    </span>
                                                </div>
                                                {% if sale.agreement %}
                                                    <div class="col-span-2">
                                                        <p class="text-xs text-gray-500 uppercase font-medium mb-1">Linked Agreement</p>
                                                        <span class="text-sm font-mono text-gray-700 bg-white border border-gray-200 px-1 py-1 rounded">
                                                            {{ sale.agreement.purchase_agreement_number }}
                                                        </span>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <!-- Items Table -->
                                        <div class="p-8">
                                            <table class="w-full text-left">
                                                <thead>
                                                    <tr class="border-b border-gray-200">
                                                        <th class="pb-3 text-xs font-medium text-gray-600 uppercase tracking-wide w-1/2">Item Description</th>
                                                        <th class="pb-3 text-xs font-medium text-gray-600 uppercase tracking-wide text-center">Qty</th>
                                                        <th class="pb-3 text-xs font-medium text-gray-600 uppercase tracking-wide text-right">Unit Price</th>
                                                        <th class="pb-3 text-xs font-medium text-gray-600 uppercase tracking-wide text-right">Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y divide-gray-100">
                                                    <!-- Boxed Sales Loop -->
                                                    {% for item in sale.boxed_sales.all %}
                                                        <tr class="hover:bg-gray-50">
                                                            <td class="py-4 pr-4">
                                                                <p class="text-sm font-medium text-blue-600">{{ item.product.modelname|upper }}</p>
                                                                <p class="text-xs text-gray-500">{{ item.product.brand.name }} â€¢ {{ item.product.type_variant | upper }}</p>
                                                            </td>
                                                            <td class="py-4 px-4 text-center">
                                                                <span class="text-sm font-mono text-gray-800 bg-gray-100 px-2 py-0.5 rounded">{{ item.quantity }}</span>
                                                            </td>
                                                            <td class="py-4 px-4 text-right text-sm text-gray-900 font-mono">{{ item.price|floatformat:2|intcomma }}</td>
                                                            <td class="py-4 pl-4 text-right text-sm font-medium text-gray-900 font-mono">
                                                                {% widthratio item.price 1 item.quantity as total %}
                                                                {{ total|intcomma }}
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                    <!-- Coupled Sales Loop -->
                                                    {% for item in sale.coupled_sales.all %}
                                                        <tr class="hover:bg-gray-50">
                                                            <td class="py-4 pr-4">
                                                                <p class="text-sm font-medium text-blue-600">{{ item.transformation_item.target_product.modelname|upper }}</p>
                                                                <p class="text-xs text-gray-500">{{ item.transformation_item.item_number }}</p>
                                                            </td>
                                                            <td class="py-4 px-4 text-center">
                                                                <span class="text-sm font-mono text-gray-800 bg-gray-100 px-2 py-0.5 rounded">-</span>
                                                            </td>
                                                            <td class="py-4 px-4 text-right text-sm text-gray-900 font-mono">{{ item.price|floatformat:2|intcomma }}</td>
                                                            <td class="py-4 pl-4 text-right text-sm font-medium text-gray-900 font-mono">
                                                                {{ item.price|floatformat:2|intcomma }}
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                    {% if not sale.boxed_sales.exists and not sale.coupled_sales.exists %}
                                                        <tr>
                                                            <td colspan="4" class="py-8 text-center text-gray-400 text-sm italic">No items found in this sale record.</td>
                                                        </tr>
                                                    {% endif %}
                                                </tbody>
                                            </table>
                                            <!-- Footer Totals -->
                                            <div class="mt-8 pt-8 border-t border-gray-200 flex justify-end">
                                                <div class="w-64">
                                                    <div class="flex justify-between items-center mb-2">
                                                        <span class="text-sm text-gray-500">Subtotal</span>
                                                        <span class="text-sm font-mono text-gray-900">{{ sale_total|floatformat:2|intcomma }}</span>
                                                    </div>
                                                    <div class="flex justify-between items-center py-3 border-t-2 border-gray-800 mt-2">
                                                        <span class="text-base font-bold text-gray-900">Grand Total</span>
                                                        <span class="text-lg font-bold text-gray-900 font-mono">NGN {{ sale.sales_total|floatformat:2|intcomma }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Footer Actions (Voiding) -->
                                    {% if sale.status == 'active' %}
                                        <div class="max-w-5xl mx-auto mt-6 flex justify-end">
                                            <button class="text-red-500 border border-red-200 bg-white hover:bg-red-50 hover:border-red-400 font-medium rounded-md px-3 py-1 text-sm transition-colors shadow-sm flex items-center gap-2">
                                                Void
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endblock _content %}
                        {% else %}
                            <!-- Empty State if no sales exist in DB -->
                            <div class="flex-1 flex items-center justify-center bg-gray-50">
                                <div class="text-center">
                                    <h3 class="text-lg font-medium text-gray-900">No Sales Records</h3>
                                    <p class="text-sm text-gray-500 mt-2">Create a sale from the Customer Dashboard to see it here.</p>
                                </div>
                            </div>
                        {% endif %}
                    {% endblock main_content %}
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
