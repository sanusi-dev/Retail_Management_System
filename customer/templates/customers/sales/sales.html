{% extends "index.html" %}
{% load static %}
{% load humanize %}
{% block content %}
    {% include "partials/spinner.html" with id="body_spinner" %}
    <div class="flex h-full flex-col" id="main_body">
        {% block header %}
            <div class="h-16 flex items-center justify-between px-4 border-b border-gray-200 bg-white">
                <!-- Title & Filter Placeholder -->
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-bold text-gray-900">All Sales</h1>
                    {% include "partials/table_filter.html" with view_name="Sales" %}
                </div>
                {% comment %} <div class="flex items-center gap-4">
                    <h1 class="text-xl font-bold text-gray-900">All Sales</h1>
                    <form class="flex items-center gap-3" id="sales_filter_form" hx-get="." hx-target="#table_container" hx-indicator="#body_spinner" hx-trigger="change, search">
                        <select name="status" class="block w-32 py-2 px-3 text-sm border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Status: All</option>
                            <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Active</option>
                            <option value="voided" {% if request.GET.status == 'voided' %}selected{% endif %}>Voided</option>
                        </select>
                        <select name="payment_method" class="block w-40 py-2 px-3 text-sm border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Payment: All Modes</option>
                            <option value="cash" {% if request.GET.payment_method == 'cash' %}selected{% endif %}>Cash</option>
                            <option value="card" {% if request.GET.payment_method == 'card' %}selected{% endif %}>Card</option>
                            <option value="bank_transfer" {% if request.GET.payment_method == 'bank_transfer' %}selected{% endif %}>Bank Transfer</option>
                            <option value="from_deposit" {% if request.GET.payment_method == 'from_deposit' %}selected{% endif %}>From Deposit</option>
                        </select>
                        <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="block w-36 py-2 px-3 text-sm border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Start Date" title="Start Date">
                        <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="block w-36 py-2 px-3 text-sm border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="End Date" title="End Date">
                        <div class="relative">
                            <input type="search" name="q" value="{{ request.GET.q }}" placeholder="Search # or Customer..." class="block w-64 py-2 pl-10 pr-3 text-sm border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        {% if request.GET %}
                            <button type="button" hx-get="." hx-target="#table_container" hx-indicator="#body_spinner" class="text-gray-500 hover:text-red-600 transition-colors text-sm">
                                Reset Filters
                            </button>
                        {% endif %}
                    </form>
                </div> {% endcomment %}
                <!-- New Sale Button -->
                <a href="{% url 'customers' %}"
                   class="px-3 py-2 text-sm font-medium text-center inline-flex items-center text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:ring-1 focus:outline-none focus:ring-blue-200 transition-colors shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         viewBox="0 0 20 20"
                         fill="currentColor"
                         class="size-5 mr-1">
                        <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
                    </svg>
                    New Sale
                </a>
            </div>
        {% endblock header %}
        {% block body %}
            <div id="table_container"
                 class="relative flex flex-col h-[calc(100vh-8rem)] bg-gray-50">
                <!-- Scrollable Table Area -->
                <div class="flex-1 overflow-y-auto pb-20 p-2">
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-500 font-normal uppercase bg-gray-50 border-b border-gray-200 sticky top-0 z-10">
                                <tr>
                                    <th scope="col" class="px-6 py-3 font-medium">Date</th>
                                    <th scope="col" class="px-6 py-3 font-medium">Sale #</th>
                                    <th scope="col" class="px-6 py-3 font-medium">Customer</th>
                                    <th scope="col" class="px-6 py-3 font-medium">Payment Mode</th>
                                    <th scope="col" class="px-6 py-3 font-medium text-center">Items</th>
                                    <th scope="col" class="px-6 py-3 font-medium text-center">Status</th>
                                    <th scope="col" class="px-6 py-3 font-medium text-right">Total Amount</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm text-gray-700 divide-y divide-gray-100">
                                {% if sales %}
                                    {% for sale in sales %}
                                        <tr class="hover:bg-blue-50 cursor-pointer transition-colors duration-150 group"
                                            hx-get="{% url 'sale_detail' sale.pk %}"
                                            hx-target="#main_body"
                                            hx-indicator="#body_spinner"
                                            hx-push-url="true">
                                            <!-- Date -->
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="block text-gray-900 font-medium">{{ sale.sale_date|date:"M d, Y" }}</span>
                                                <span class="block text-xs text-gray-400">{{ sale.sale_date|date:"H:i" }}</span>
                                            </td>
                                            <!-- Sale Number -->
                                            <td class="px-6 py-4 whitespace-nowrap font-mono text-xs text-gray-600 group-hover:text-blue-600">
                                                {{ sale.sale_number }}
                                            </td>
                                            <!-- Customer -->
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center gap-2">
                                                    <span class="font-medium text-gray-900">{{ sale.customer.full_name|upper }}</span>
                                                </div>
                                            </td>
                                            <!-- Payment Method -->
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                {% if sale.payment_method == 'from_deposit' %}
                                                    <span class="inline-flex items-center gap-1 text-xs text-purple-700 bg-purple-50 px-2 py-1 rounded border border-purple-100">
                                                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                                        </svg>
                                                        From Deposit
                                                    </span>
                                                {% else %}
                                                    <span class="inline-flex items-center gap-1 text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded border border-gray-200 capitalize">
                                                        {{ sale.payment_method }}
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <!-- Items Count -->
                                            <td class="px-6 py-4 text-center text-xs text-gray-500">{{ sale.sales_items_count }}</td>
                                            <!-- Status -->
                                            <td class="px-6 py-4 text-center">
                                                {% if sale.status == 'active' %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                        Active
                                                    </span>
                                                {% else %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                        Voided
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <!-- Total Amount -->
                                            <td class="px-6 py-4 text-right font-mono font-bold text-gray-900">
                                                NGN {{ sale.sales_total|floatformat:2|intcomma }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr class="bg-white border-b border-gray-100">
                                        <td colspan="7" class="px-6 py-16 text-center text-gray-400">
                                            <div class="flex flex-col items-center justify-center gap-2">
                                                <svg class="w-10 h-10 text-gray-300"
                                                     fill="none"
                                                     viewBox="0 0 24 24"
                                                     stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                                </svg>
                                                <p>No sales records found.</p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Pagination -->
                <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-2 z-20">
                    <div class="flex justify-end">
                        {% include 'partials/pagination.html' with page_obj=sales target="table_container" %}
                    </div>
                </div>
            </div>
        {% endblock body %}
    </div>
{% endblock content %}
