{% extends 'index.html' %}
{% load static %}
{% load humanize %}
{% block content %}
    {% include "partials/spinner.html" with id="body_spinner" %}
    <div class="flex flex-col h-full" id="main_body">
        <div class="flex flex-row h-full">
            <!-- SIDEBAR: CUSTOMER LIST -->
            {% block _side_bar %}
                <div x-data="{ activeCustomer: '{{ customer.pk }}' }"
                     class="flex-none w-[320px] h-screen bg-white border-r flex flex-col z-20">
                    <!-- Sidebar Header -->
                    <div class="flex-none border-b">
                        <div class="h-16 flex items-center justify-between px-4 py-2">
                            <h4 class="text-gray-900 text-lg font-medium">Customers</h4>
                            <a href="{% url 'add_customer' %}"
                               hx-boost="true"
                               hx-target="#main_body"
                               hx-indicator="#body_spinner"
                               class="p-1.5 text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     viewBox="0 0 20 20"
                                     fill="currentColor"
                                     class="size-5">
                                    <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
                                </svg>
                            </a>
                        </div>
                    </div>
                    <!-- Sidebar List -->
                    {% block side_bar_list %}
                        <div id="sidebar_pagination" class="flex-1 flex flex-col min-h-0">
                            <div id="side_bar" class="flex-1 overflow-y-auto min-h-0">
                                {% for cust in customer_list %}
                                    <a href="{% url 'customer_detail' pk=cust.pk %}"
                                       class="py-3 px-5 border-b hover:bg-gray-50 transition-colors duration-150 flex flex-col gap-1 group"
                                       hx-boost="true"
                                       hx-target="#main_content"
                                       hx-indicator="#side_bar_spinner"
                                       @click="activeCustomer = '{{ cust.pk }}'"
                                       x-bind:class="{'bg-blue-50 border-r-4 border-r-blue-600': activeCustomer === '{{ cust.pk }}'}">
                                        <div class="flex justify-between w-full">
                                            <h4 class="text-gray-800 font-medium text-sm truncate w-32"
                                                x-bind:class="{'text-blue-700': activeCustomer === '{{ cust.pk }}'}">
                                                {{ cust.full_name|upper }}
                                            </h4>
                                            <span class="text-xs font-mono text-gray-400 group-hover:text-gray-500">{{ cust.customer_number }}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-gray-400">Available Cash:</span>
                                            <span class="text-xs font-mono font-medium"
                                                  class="{% if cust.deposit_account.available_balance > 0 %}
                                                             text-green-600
                                                         {% else %}
                                                             text-gray-400
                                                         {% endif %}">
                                                NGN {{ cust.deposit_account.available_balance|floatformat:0|intcomma }}
                                            </span>
                                        </div>
                                    </a>
                                {% endfor %}
                            </div>
                            <div class="flex-none sticky bottom-0 bg-white border-t border-gray-200 p-2 z-10">
                                <div class="flex justify-end">
                                    {% include "partials/pagination.html" with page_obj=customer_list target="sidebar_pagination" %}
                                </div>
                            </div>
                        </div>
                    {% endblock side_bar_list %}
                </div>
            {% endblock _side_bar %}
            <!-- MAIN CONTENT: THE DASHBOARD -->
            <div class="flex-1 flex flex-col relative min-w-0" id="content-wrapper">
                {% include "partials/spinner.html" with id="side_bar_spinner" %}
                <div id="main_content" class="h-full flex flex-col">
                    {% block main_content %}
                        <!-- Top Header -->
                        {% block _header %}
                            <div class="flex-none bg-white border-b border-gray-200 py-3 px-6 h-16 shadow-sm z-20">
                                <div class="flex justify-between items-center h-full">
                                    <div class="flex items-center gap-3">
                                        <div class="h-8 w-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs border border-blue-200">
                                            {{ customer.full_name|slice:":2"|upper }}
                                        </div>
                                        <h1 class="text-xl font-bold text-gray-900 truncate">{{ customer.full_name|upper }}</h1>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <a href="{% url 'edit_customer' customer.pk %}"
                                           hx-boost="true"
                                           hx-target="#main_body"
                                           class="text-gray-600 hover:text-blue-600 bg-gray-50 hover:bg-blue-50 px-3 py-1.5 border border-gray-300 rounded-md text-sm font-medium transition-colors">
                                            Edit Profile
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endblock _header %}
                        <!-- Scrollable Dashboard Area -->
                        {% block _content %}
                            <div id="_content" class="flex-1 overflow-y-auto bg-gray-50 p-6">
                                <!-- FINANCIAL WALLET -->
                                {% include "customers/partials/customer_wallet.html" %}
                                <!-- TABS & IDENTITY -->
                                <div class="flex flex-col xl:flex-row gap-6 h-full">
                                    <!-- LEFT COLUMN: TABS -->
                                    <div class="flex-1 bg-white rounded-lg border border-gray-200 shadow-sm min-h-[600px]"
                                         x-data="{ activeTab: 'overview' }">
                                        <!-- Tab Headers -->
                                        <div class="border-b border-gray-200 px-6 pt-4 flex gap-8 overflow-x-auto">
                                            <button @click="activeTab = 'overview'"
                                                    :class="{ 'border-blue-500 text-blue-600': activeTab === 'overview', 'border-transparent text-gray-500 hover:text-gray-700': activeTab !== 'overview' }"
                                                    class="pb-3 px-1 border-b-2 font-medium text-sm transition-colors whitespace-nowrap">
                                                Purchase Agreements
                                            </button>
                                            <button @click="activeTab = 'cfa'"
                                                    :class="{ 'border-purple-500 text-purple-600': activeTab === 'cfa', 'border-transparent text-gray-500 hover:text-gray-700': activeTab !== 'cfa' }"
                                                    class="pb-3 px-1 border-b-2 font-medium text-sm transition-colors whitespace-nowrap">
                                                CFA Agreements
                                            </button>
                                            <button @click="activeTab = 'transactions'"
                                                    :class="{ 'border-green-500 text-green-600': activeTab === 'transactions', 'border-transparent text-gray-500 hover:text-gray-700': activeTab !== 'transactions' }"
                                                    class="pb-3 px-1 border-b-2 font-medium text-sm transition-colors whitespace-nowrap">
                                                Transaction Ledger
                                            </button>
                                            <button @click="activeTab = 'sales'"
                                                    :class="{ 'border-gray-500 text-gray-700': activeTab === 'sales', 'border-transparent text-gray-500 hover:text-gray-700': activeTab !== 'sales' }"
                                                    class="pb-3 px-1 border-b-2 font-medium text-sm transition-colors whitespace-nowrap">
                                                Sales History
                                            </button>
                                        </div>
                                        <!-- Tab Content -->
                                        <div class="p-6 h-[600px] overflow-y-auto">
                                            <div x-show="activeTab === 'overview'"
                                                 class="flex flex-col h-full"
                                                 x-cloak>
                                                <!-- Header & Filters -->
                                                <div class="flex flex-col gap-4 mb-4 flex-none">
                                                    <div class="flex justify-between items-center">
                                                        <div>
                                                            <h3 class="font-bold text-gray-800 text-lg">Purchase Agreements</h3>
                                                            <p class="text-sm text-gray-500">Manage allocations and fulfillment.</p>
                                                        </div>
                                                        <a href="{% url 'add_purchase_agreement' %}?customer={{ customer.pk }}"
                                                           hx-boost="true"
                                                           hx-target="#main_body"
                                                           hx-indicator="#body_spinner"
                                                           class="flex items-center gap-2 px-4 py-2 bg-brand-600 text-white rounded-md text-sm font-medium hover:bg-brand-700 shadow-sm transition-colors">
                                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                            </svg>
                                                            New Agreement
                                                        </a>
                                                    </div>
                                                    <!-- Filters -->
                                                    <div class="flex gap-2">
                                                        <!-- REMOVED EMPTY hx-get to prevent breakage -->
                                                        <div class="relative flex-1">
                                                            <input type="text"
                                                                   placeholder="Search agreement number..."
                                                                   class="pl-3 pr-4 py-2 border border-gray-300 rounded-md text-sm w-full focus:ring-blue-500 focus:border-blue-500"
                                                                   name="search">
                                                        </div>
                                                        <select class="border border-gray-300 rounded-md text-sm py-2 pl-3 pr-8 focus:ring-blue-500 focus:border-blue-500"
                                                                name="status"
                                                                hx-get="{% url 'filter_agreements_partial' customer.pk %}"
                                                                hx-trigger="change"
                                                                hx-target="#purchase-agreements-list"
                                                                hx-swap="outerHTML">
                                                            <option value="">All Statuses</option>
                                                            <option value="ACTIVE">Active</option>
                                                            <option value="PARTIALLY_FULFILLED">Partial</option>
                                                            <option value="FULFILLED">Fulfilled</option>
                                                            <option value="CANCELLED">Cancelled</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                {% include "customers/partials/purchase_agreements_list.html" with agreements=customer.deposit_account.purchase_agreements.all %}
                                            </div>
                                            <div x-show="activeTab === 'cfa'" class="flex flex-col h-full" x-cloak>
                                                <!-- Header & Filters -->
                                                <div class="flex flex-col gap-4 mb-4 flex-none">
                                                    <div class="flex justify-between items-center">
                                                        <div>
                                                            <h3 class="font-bold text-gray-800 text-lg">CFA Agreements</h3>
                                                            <p class="text-sm text-gray-500">Foreign exchange allocations.</p>
                                                        </div>
                                                        <a href="{% url 'add_cfa_agreement' %}?customer={{ customer.pk }}"
                                                           class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-md text-sm font-medium hover:bg-purple-700 shadow-sm transition-colors">
                                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                                            </svg>
                                                            New Allocation
                                                        </a>
                                                    </div>
                                                    <!-- Filters -->
                                                    <div class="flex gap-2">
                                                        <div class="relative flex-1">
                                                            <input type="text"
                                                                   placeholder="Search CFA ref..."
                                                                   class="pl-3 pr-4 py-2 border border-gray-300 rounded-md text-sm w-full focus:ring-purple-500 focus:border-purple-500"
                                                                   name="search">
                                                        </div>
                                                        <select class="border border-gray-300 rounded-md text-sm py-2 pl-3 pr-8 focus:ring-blue-500 focus:border-blue-500"
                                                                name="status"
                                                                hx-get="{% url 'filter_cfa_agreements_partial' customer.pk %}"
                                                                hx-trigger="change"
                                                                hx-target="#cfa-agreements-list"
                                                                hx-swap="outerHTML">
                                                            <option value="">All Statuses</option>
                                                            <option value="ACTIVE">Active</option>
                                                            <option value="PARTIALLY_FULFILLED">Partial</option>
                                                            <option value="FULFILLED">Fulfilled</option>
                                                            <option value="CANCELLED">Cancelled</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                {% include "customers/partials/cfa_agreements_list.html" with cfas=customer.deposit_account.cfa_agreements.all %}
                                            </div>
                                            <!-- TRANSACTIONS -->
                                            <div x-show="activeTab === 'transactions'" style="display: none;">
                                                <div class="overflow-x-auto">
                                                    <table class="w-full text-left border-collapse">
                                                        <thead>
                                                            <tr class="bg-gray-50 text-xs uppercase text-gray-500 border-b border-gray-200">
                                                                <th class="px-4 py-3">Date</th>
                                                                <th class="px-4 py-3">Ref</th>
                                                                <th class="px-4 py-3">Type</th>
                                                                <th class="px-4 py-3 text-right">Amount</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody class="text-sm divide-y divide-gray-100">
                                                            {% for txn in customer.deposit_account.transactions.all|slice:":9" %}
                                                                <tr>
                                                                    <td class="px-4 py-3 font-mono text-xs text-gray-600">{{ txn.created_at|date:"M d, Y H:i" }}</td>
                                                                    <td class="px-4 py-3 font-mono text-xs text-gray-600">{{ txn.reference_number }}</td>
                                                                    <td class="px-4 py-3">
                                                                        {% if txn.transaction_type == 'deposit' %}
                                                                            <span class="text-green-600 text-xs font-bold bg-green-50 px-2 py-1 rounded">DEP</span>
                                                                        {% elif txn.transaction_type == 'withdrawal' %}
                                                                            <span class="text-red-600 text-xs font-bold bg-red-50 px-2 py-1 rounded">WTH</span>
                                                                        {% elif txn.transaction_type == "refund" %}
                                                                            <span class="text-blue-600 text-xs font-bold bg-blue-50 px-2 py-1 rounded">REF</span>
                                                                        {% else %}
                                                                            <span class="text-green-600 text-xs font-bold bg-green-50 px-2 py-1 rounded">FUL</span>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td class="px-4 py-3 text-right font-mono text-gray-700">NGN {{ txn.amount|floatformat:2|intcomma }}</td>
                                                                </tr>
                                                            {% empty %}
                                                                <tr>
                                                                    <td colspan="3" class="text-center py-4 text-gray-400">No transactions yet.</td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="pt-4 flex justify-center flex-none border-t border-gray-100 mt-2">
                                                    <a href="{% url 'customer_transactions' %}?customer={{ customer.pk }}"
                                                       hx-boost="true"
                                                       hx-target="#main_body"
                                                       hx-indicator="#body_spinner"
                                                       class="text-sm font-medium text-green-600 hover:text-green-800 flex items-center gap-1 transition-colors px-4 py-2 hover:bg-green-50 rounded-full">
                                                        View All Transactions
                                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                                                        </svg>
                                                    </a>
                                                </div>
                                            </div>
                                            <!-- SALES HISTORY -->
                                            <div x-show="activeTab === 'sales'" style="display: none;">
                                                <div class="overflow-x-auto">
                                                    <table class="w-full text-left border-collapse">
                                                        <thead>
                                                            <tr class="bg-gray-50 text-xs uppercase text-gray-500 border-b border-gray-200">
                                                                <th class="px-4 py-3">Sale No.</th>
                                                                <th class="px-4 py-3">Date</th>
                                                                <th class="px-4 py-3">Method</th>
                                                                <th class="px-4 py-3 text-center">Status</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody class="text-sm divide-y divide-gray-100">
                                                            {% for sale in customer.customer_sales.all|slice:":9" %}
                                                                <tr class="hover:bg-gray-50">
                                                                    <td class="px-4 py-3 font-mono text-xs text-gray-700 font-medium">{{ sale.sale_number }}</td>
                                                                    <td class="px-4 py-3 text-gray-500 text-xs">{{ sale.sale_date|date:"M d, Y" }}</td>
                                                                    <td class="px-4 py-3 text-xs capitalize text-gray-600">{{ sale.payment_method }}</td>
                                                                    <td class="px-4 py-3 text-center">
                                                                        {% if sale.status == 'voided' %}
                                                                            <span class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase">Voided</span>
                                                                        {% else %}
                                                                            <span class="bg-green-100 text-green-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase">Active</span>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                            {% empty %}
                                                                <tr>
                                                                    <td colspan="4" class="text-center py-10 text-gray-400">No sales records found.</td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="pt-4 flex justify-center flex-none border-t border-gray-100 mt-2">
                                                    <a href="{% url 'sales' %}?customer={{ customer.pk }}"
                                                       hx-boost="true"
                                                       hx-target="#main_body"
                                                       hx-indicator="#body_spinner"
                                                       class="text-sm font-medium text-green-600 hover:text-green-800 flex items-center gap-1 transition-colors px-4 py-2 hover:bg-green-50 rounded-full">
                                                        View All Sales
                                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                                                        </svg>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- RIGHT COLUMN: INFO & ACTIONS -->
                                    <div class="w-full xl:w-[300px] flex flex-col gap-6">
                                        <!-- Info Card -->
                                        <div class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm">
                                            <h3 class="font-medium text-gray-900 mb-4 border-b pb-2">Contact Details</h3>
                                            <div class="space-y-4 text-sm">
                                                <div>
                                                    <p class="text-gray-500 text-xs mb-1">PHONE NUMBER</p>
                                                    <p class="font-medium text-gray-800">{{ customer.phone }}</p>
                                                </div>
                                                <div>
                                                    <p class="text-gray-500 text-xs mb-1">CUSTOMER ID</p>
                                                    <p class="font-mono text-gray-800">{{ customer.customer_number }}</p>
                                                </div>
                                                {% if customer.email %}
                                                    <div>
                                                        <p class="text-gray-500 text-xs mb-1">EMAIL</p>
                                                        <p class="font-medium text-gray-800">{{ customer.email }}</p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <!-- Quick Actions -->
                                        <div class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm">
                                            <h3 class="font-medium text-gray-900 mb-4 border-b pb-2">Quick Actions</h3>
                                            <div class="space-y-3">
                                                <!-- Deposit Button -->
                                                <a href="{% url 'add_transaction' %}?customer={{ customer.pk }}&type=deposit"
                                                   hx-boost="true"
                                                   hx-target="#main_body"
                                                   hx-indicator="#body_spinner"
                                                   class="flex items-center justify-center gap-2 w-full py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
                                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                                    </svg>
                                                    Make Deposit
                                                </a>
                                                <!-- Withdrawal Button -->
                                                <a href="{% url 'add_transaction' %}?customer={{ customer.pk }}&type=withdrawal"
                                                   hx-boost="true"
                                                   hx-target="#main_body"
                                                   hx-indicator="#body_spinner"
                                                   class="flex items-center justify-center gap-2 w-full py-2 bg-white border border-red-200 text-red-600 rounded-md text-sm font-medium hover:bg-red-50 hover:border-red-300 transition-colors shadow-sm">
                                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                    Withdraw Funds
                                                </a>
                                                <!-- New Sale Button -->
                                                <a href="{% url 'add_sale' %}?customer={{ customer.pk }}"
                                                   class="flex items-center justify-center gap-2 w-full py-2 bg-white border border-gray-300 text-gray-700 rounded-md text-sm font-medium hover:bg-gray-50 transition-colors shadow-sm">
                                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                                    </svg>
                                                    Create Sale
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endblock _content %}
                    {% endblock main_content %}
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
