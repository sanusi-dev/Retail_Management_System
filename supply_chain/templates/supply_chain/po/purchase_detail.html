{% extends 'index.html' %}
{% load static %}
{% load color_filters %}
{% load field_name %}
{% block content %}
   {% include "partials/spinner.html" with id="body_spinner" %}
   <div class="flex flex-col h-full" id="main_body">
      <div class="flex flex-row h-full">
         {% block _side_bar %}
            <div x-data="{ activePurchase: '{{ purchase.pk }}' }"
                 class="flex-none w-[360px] h-screen bg-white border-r flex flex-col">
               <div class="flex-none border-b">
                  <div class="h-16 flex items-center justify-between px-2 py-2">
                     <h4 class="text-gray-900 text-lg font-medium">All Purchase Orders</h4>
                     <a href="{% url 'add_po' %}?next={{ request.path }}"
                        hx-boost="true"
                        hx-target="#main_body"
                        hx-indicator="#body_spinner"
                        class="px-1 py-1 text-md font-medium text-center text-white bg-blue-500 rounded-md hover:bg-blue-600 focus:ring-1 focus:outline-none focus:ring-blue-200">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             viewBox="0 0 20 20"
                             fill="currentColor"
                             class="size-6">
                           <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
                        </svg>
                     </a>
                  </div>
               </div>
               {% block side_bar_list %}
                  <div id="sidebar_pagination" class="flex-1 flex flex-col min-h-0">
                     <div id="side_bar" class="flex-1 overflow-y-auto min-h-0">
                        {% for po in purchase_list %}
                           <a href="{% url 'po_detail' pk=po.pk %}"
                              class="h-16 flex items-center justify-between px-5 border-b hover:bg-gray-100 transition-colors duration-150"
                              hx-boost="true"
                              hx-target="#main_content"
                              hx-indicator="#side_bar_spinner"
                              @click="activePurchase = '{{ po.pk }}'"
                              x-bind:class="{'bg-blue-50 border-r-2 border-r-blue-500': activePurchase === '{{ po.pk }}' }">
                              <div class="flex flex-col">
                                 <h4 class="text-gray-800 font-medium text-sm">{{ po.supplier.name|upper }}</h4>
                                 <p class="text-xs text-gray-600">{{ po.po_number }} â€¢ {{ po.order_date | date:"Y-m-d" }}</p>
                              </div>
                              {% if po.payment_status == po.PaymentStatus.FULFILLED and po.delivery_status == po.DeliveryStatus.RECEIVED %}
                                 <h4 class="text-gray-800 font-medium text-sm {{ po.status | status_color }}">{{ po.status | upper }}</h4>
                              {% elif po.payment_status == po.PaymentStatus.FULFILLED %}
                                 <h4 class="text-gray-800 font-medium text-sm {{ po.payment_status | status_color }}">
                                    {{ po.payment_status | upper }}
                                 </h4>
                              {% else %}
                                 <h4 class="text-gray-800 font-medium text-sm">NGN {{ po.total_payment_made|floatformat:"2g" }}</h4>
                              {% endif %}
                           </a>
                        {% endfor %}
                     </div>
                     <div class="flex-none sticky bottom-0 bg-white border-t border-gray-200 p-2 z-10">
                        <div class="flex justify-end">
                           {% include "partials/pagination.html" with page_obj=purchase_list target="sidebar_pagination" %}
                        </div>
                     </div>
                  </div>
               {% endblock side_bar_list %}
            </div>
         {% endblock _side_bar %}
         <div class="flex-1 bg-white relative" id="content-wrapper">
            {% include "partials/spinner.html" with id="side_bar_spinner" %}
            <div id="main_content">
               {% block main_content %}
                  {% block _header %}
                     <div class="flex-none bg-white py-3 px-5 h-16 border border-b">
                        <div class="flex justify-between items-start">
                           <h1 class="text-lg font-medium text-gray-900">{{ purchase.po_number|upper }}</h1>
                           <div class="flex inline-items items-center gap-2">
                              <a href="{{ purchase.get_edit_url }}"
                                 hx-boost="true"
                                 hx-target="#main_body"
                                 hx-indicator="#body_spinner"
                                 class="text-gray-600 bg-gray-100 px-1 py-1 border border-gray-300 rounded-md">
                                 <svg xmlns="http://www.w3.org/2000/svg"
                                      fill="none"
                                      viewBox="0 0 24 24"
                                      stroke-width="1.5"
                                      stroke="currentColor"
                                      class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0 0 21 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 0 0-1.913-.247M6.34 18H5.25A2.25 2.25 0 0 1 3 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 0 1 1.913-.247m10.5 0a48.536 48.536 0 0 0-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5Zm-3 0h.008v.008H15V10.5Z" />
                                 </svg>
                              </a>
                              {% if purchase.can_make_payment %}
                                 <a href="{% url 'add_payment' %}?purchase_order={{ purchase.pk }}"
                                    hx-boost="true"
                                    hx-target="#main_body"
                                    hx-indicator="#body_spinner"
                                    class="flex items-center gap-1 bg-gray-100 py-1 px-2 border border-gray-300 rounded-md text-md font-light text-gray-900 transition-colors duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         fill="none"
                                         viewBox="0 0 24 24"
                                         stroke-width="1.5"
                                         stroke="currentColor"
                                         class="size-5">
                                       <path stroke-linecap="round" stroke-linejoin="round" d="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0-3-3m3 3 3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" />
                                    </svg>
                                    <span>Payment</span>
                                 </a>
                              {% endif %}
                              {% if purchase.can_receive %}
                                 <a href="{% url 'add_receipt' %}?purchase_order={{ purchase.pk }}"
                                    hx-boost="true"
                                    hx-target="#main_body"
                                    hx-indicator="#body_spinner"
                                    class="flex items-center gap-1 bg-gray-100 py-1 px-2 border border-gray-300 rounded-md text-md font-light text-gray-900 transition-colors duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         fill="none"
                                         viewBox="0 0 24 24"
                                         stroke-width="1.5"
                                         stroke="currentColor"
                                         class="size-5">
                                       <path stroke-linecap="round" stroke-linejoin="round" d="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0-3-3m3 3 3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" />
                                    </svg>
                                    <span>Receive</span>
                                 </a>
                              {% endif %}
                              <a href="{{ purchase.get_edit_url }}"
                                 hx-boost="true"
                                 hx-target="#main_body"
                                 hx-indicator="#body_spinner"
                                 class="text-gray-600 bg-gray-100 px-1 py-1 border border-gray-300 rounded-md">
                                 <svg xmlns="http://www.w3.org/2000/svg"
                                      viewBox="0 0 16 16"
                                      fill="currentColor"
                                      class="size-6">
                                    <path d="M13.488 2.513a1.75 1.75 0 0 0-2.475 0L6.75 6.774a2.75 2.75 0 0 0-.596.892l-.848 2.047a.75.75 0 0 0 .98.98l2.047-.848a2.75 2.75 0 0 0 .892-.596l4.261-4.262a1.75 1.75 0 0 0 0-2.474Z" />
                                    <path d="M4.75 3.5c-.69 0-1.25.56-1.25 1.25v6.5c0 .69.56 1.25 1.25 1.25h6.5c.69 0 1.25-.56 1.25-1.25V9A.75.75 0 0 1 14 9v2.25A2.75 2.75 0 0 1 11.25 14h-6.5A2.75 2.75 0 0 1 2 11.25v-6.5A2.75 2.75 0 0 1 4.75 2H7a.75.75 0 0 1 0 1.5H4.75Z" />
                                 </svg>
                              </a>
                              <div class="relative" x-data="{ open: false }">
                                 <button @click="open = !open"
                                         @click.away="open = false"
                                         class="flex items-center gap-1 bg-gray-100 py-1 px-2 border border-gray-300 rounded-md text-md font-light text-gray-900 transition-colors duration-200">
                                    <span>More</span>
                                    <svg class="w-2 h-2 text-gray-900 transition-transform duration-150"
                                         :class="{ 'rotate-180': open }"
                                         xmlns="http://www.w3.org/2000/svg"
                                         fill="none"
                                         viewBox="0 0 24 24"
                                         stroke="currentColor">
                                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                 </button>
                                 <div x-show="open"
                                      x-transition:enter="transition ease-in-out duration-50"
                                      x-transition:enter-start="opacity-0 translate-y-1"
                                      x-transition:enter-end="opacity-100 translate-y-0"
                                      x-transition:leave="transition ease-in-out duration-50"
                                      x-transition:leave-start="opacity-100 translate-y-0"
                                      x-transition:leave-end="opacity-0 translate-y-1"
                                      class="absolute top-full right-0 mt-2 w-35 bg-white border border-gray-200 rounded-md shadow-lg z-[100]">
                                    <div class="py-1 flex flex-col">
                                       {% if purchase.can_delete %}
                                          <button hx-delete="{{ purchase.get_delete_url }}"
                                                  hx-swap="outerHTML"
                                                  hx-target="#main_body"
                                                  hx-indicator="#body_spinner"
                                                  hx-confirm="Are you sure you want to delete this purchase?"
                                                  class="px-3 py-2 text-sm w-full text-gray-700 hover:bg-gray-100 transition-colors duration-150 text-left">
                                             Delete
                                          </button>
                                       {% endif %}
                                    </div>
                                 </div>
                              </div>
                              <button onclick="history.back()"
                                      class="text-gray-600 hover:text-gray-600 transition-colors">
                                 <svg xmlns="http://www.w3.org/2000/svg"
                                      fill="none"
                                      viewBox="0 0 24 24"
                                      stroke-width="1.5"
                                      stroke="currentColor"
                                      class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                 </svg>
                              </button>
                           </div>
                        </div>
                     </div>
                  {% endblock _header %}
                  {% block _content %}
                     <div id="_content"
                          class="flex-1 pb-10 h-screen overflow-y-auto flex flex-col bg-gray-50">
                        <div class="m-5 flex-none" x-data="{ open: false }">
                           <button @click="open = !open"
                                   class="flex items-center gap-1 bg-gray-50 py-3 px-3 border border-gray-200 text-md font-semibold text-gray-700 transition-all duration-200 w-full"
                                   :class="open ? 'rounded-t-lg border-b-0' : 'rounded-lg'">
                              <svg class="w-3 h-3 text-blue-700 transition-transform duration-150"
                                   :class="{ 'rotate-180': open }"
                                   xmlns="http://www.w3.org/2000/svg"
                                   fill="none"
                                   viewBox="0 0 24 24"
                                   stroke="currentColor">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                              </svg>
                              <span>Payments
                                 <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-blue-500 bg-gray-300 rounded-full ml-1">
                                    {{ purchase.payments.count }}
                                 </span>
                              </span>
                           </button>
                           <div x-show="open"
                                x-transition:enter="transition ease-out duration-300"
                                x-transition:enter-start="opacity-0"
                                x-transition:enter-end="opacity-100"
                                x-transition:leave="transition ease-in duration-200"
                                x-transition:leave-start="opacity-100"
                                x-transition:leave-end="opacity-0"
                                class="border border-t border-gray-200 bg-white rounded-b-lg overflow-hidden">
                              <div class="overflow-y-auto max-h-96">
                                 <div class="relative overflow-x-auto">
                                    <table class="w-full text-sm text-left text-gray-500">
                                       <thead class="text-xs text-gray-500 font-normal uppercase bg-gray-50 sticky top-0 z-10">
                                          <tr class="border-t border-b">
                                             <th scope="col" class="px-6 py-3">Date</th>
                                             <th scope="col" class="px-6 py-3">Payment#</th>
                                             <th scope="col" class="px-6 py-3">Supplier name</th>
                                             <th scope="col" class="px-6 py-3">Mode</th>
                                             <th scope="col" class="px-6 py-3">Status</th>
                                             <th scope="col" class="px-6 py-3 text-right">Amount</th>
                                          </tr>
                                       </thead>
                                       <tbody class="text-sm text-black font-light">
                                          {% if purchase.payments %}
                                             {% for payment in purchase.payments.all %}
                                                <tr class="bg-white border-b border-gray-100 hover:bg-gray-50 cursor-pointer"
                                                    hx-get="{{ payment.get_absolute_url }}"
                                                    hx-target="#main_body"
                                                    hx-indicator="#body_spinner"
                                                    hx-push-url="true">
                                                   <td class="px-6 py-3 capitalize">{{ payment.payment_date|date:"j F Y" }}</td>
                                                   <td class="px-6 py-3 capitalize">{{ payment.trxn_ref }}</td>
                                                   <td class="px-6 py-3 capitalize">{{ payment.purchase_order.supplier.name }}</td>
                                                   <td class="px-6 py-3 capitalize">{{ payment.payment_method }}</td>
                                                   <td class="px-6 py-3 capitalize {{ payment.status | status_color }}">{{ payment.status }}</td>
                                                   <td class="px-6 py-3 text-right">NGN {{ payment.amount_paid | floatformat:"2g" }}</td>
                                                </tr>
                                             {% endfor %}
                                          {% else %}
                                             <tr class="bg-white border-b border-gray-100 hover:bg-gray-50">
                                                <td colspan="7" class="px-6 py-3 text-center">
                                                   <p>No payment has been made yet.</p>
                                                </td>
                                             </tr>
                                          {% endif %}
                                       </tbody>
                                    </table>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <div class="m-5 mt-0 flex-none" x-data="{ open: false }">
                           <button @click="open = !open"
                                   class="flex items-center gap-1 bg-gray-50 py-3 px-3 border border-gray-200 text-md font-semibold text-gray-700 transition-all duration-200 w-full"
                                   :class="open ? 'rounded-t-lg border-b-0' : 'rounded-lg'">
                              <svg class="w-3 h-3 text-blue-700 transition-transform duration-150"
                                   :class="{ 'rotate-180': open }"
                                   xmlns="http://www.w3.org/2000/svg"
                                   fill="none"
                                   viewBox="0 0 24 24"
                                   stroke="currentColor">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                              </svg>
                              <span>Recieves
                                 <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-blue-500 bg-gray-300 rounded-full ml-1">
                                    {{ purchase.goods_receipts.count }}
                                 </span>
                              </span>
                           </button>
                           <div x-show="open"
                                x-transition:enter="transition ease-out duration-300"
                                x-transition:enter-start="opacity-0"
                                x-transition:enter-end="opacity-100"
                                x-transition:leave="transition ease-in duration-200"
                                x-transition:leave-start="opacity-100"
                                x-transition:leave-end="opacity-0"
                                class="border border-t border-gray-200 bg-white rounded-b-lg overflow-hidden">
                              <div class="overflow-y-auto max-h-96">
                                 <div class="relative overflow-x-auto">
                                    <table class="w-full text-sm text-left text-gray-500">
                                       <thead class="text-xs text-gray-500 font-normal uppercase bg-gray-50 sticky top-0 z-10">
                                          <tr class="border-t border-b">
                                             <th scope="col" class="px-6 py-3">Date</th>
                                             <th scope="col" class="px-6 py-3">Purchase Receive#</th>
                                             <th scope="col" class="px-6 py-3">Supplier name</th>
                                             <th scope="col" class="px-6 py-3">Status</th>
                                             <th scope="col" class="px-6 py-3">Quantity</th>
                                          </tr>
                                       </thead>
                                       <tbody class="text-sm text-black font-light">
                                          {% if purchase.goods_receipts %}
                                             {% for receipt in purchase.goods_receipts.all %}
                                                <tr class="bg-white border-b border-gray-100 hover:bg-gray-50 cursor-pointer"
                                                    hx-get="{{ receipt.get_absolute_url }}"
                                                    hx-target="#main_body"
                                                    hx-indicator="#body_spinner"
                                                    hx-push-url="true">
                                                   <td class="px-6 py-3 capitalize">{{ receipt.delivery_date|date:"j F Y" }}</td>
                                                   <td class="px-6 py-3 capitalize">{{ receipt.gr_number }}</td>
                                                   <td class="px-6 py-3 capitalize">{{ receipt.purchase_order.supplier.name }}</td>
                                                   <td class="px-6 py-3 capitalize {{ receipt.status|status_color }}">{{ receipt.status|upper }}</td>
                                                   <td class="px-6 py-3 capitalize">{{ receipt.received_quantity }}</td>
                                                </tr>
                                             {% endfor %}
                                          {% else %}
                                             <tr class="bg-white border-b border-gray-100 hover:bg-gray-50">
                                                <td colspan="7" class="px-6 py-3 text-center">
                                                   <p>No Purchase has been received yet.</p>
                                                </td>
                                             </tr>
                                          {% endif %}
                                       </tbody>
                                    </table>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <div class="flex-1 p-6 mb-16">
                           <div class="bg-white shadow-sm max-w-5xl mx-auto mb-16">
                              <div class="flex justify-between items-start p-8 border-b border-gray-200">
                                 <div>
                                    <h1 class="text-2xl font-bold text-gray-900 mb-2">PURCHASE ORDER</h1>
                                    <p class="text-sm text-gray-600">
                                       Purchase Order# <span class="font-medium text-gray-900">{{ purchase.po_number }}</span>
                                    </p>
                                 </div>
                                 <div class="text-right">
                                    <p class="text-sm text-gray-600 mb-1">Supplier Name</p>
                                    <p class="text-blue-600 font-medium">{{ purchase.supplier.name | title }}</p>
                                 </div>
                              </div>
                              <div class="p-8 border-b border-gray-200">
                                 <div class="grid grid-cols-2 gap-8">
                                    <div>
                                       <div class="mb-6">
                                          <h3 class="text-sm font-medium text-gray-600 mb-3">STATUS</h3>
                                          <div class="border-l border-l-3 border-l-blue-500 pl-4">
                                             <div class="flex items-center gap-4">
                                                <div class="flex items-center">
                                                   <span class="text-sm w-20">Order</span>
                                                   <span class="px-2 py-0.5 bg-blue-500 text-white text-sm font-medium {{ purchase.status | status_color }} ml-0">{{ purchase.status | title }}</span>
                                                </div>
                                             </div>
                                             <div class="flex items-center gap-4 mt-2">
                                                <div class="flex items-center">
                                                   <span class="text-sm w-20">Receive</span>
                                                   <span class="text-blue-600 text-sm {{ purchase.delivery_status | status_color }} ml-0">{{ purchase.delivery_status |title }}</span>
                                                </div>
                                             </div>
                                             <div class="flex items-center gap-4 mt-2">
                                                <div class="flex items-center">
                                                   <span class="text-sm w-20">Payment</span>
                                                   <span class="text-gray-600 text-sm {{ purchase.payment_status | status_color }} ml-0">{{ purchase.payment_status | title }}</span>
                                                </div>
                                             </div>
                                          </div>
                                       </div>
                                    </div>
                                    <div>
                                       <div class="mb-4">
                                          <h3 class="text-sm font-medium text-gray-600 mb-1">ORDER DATE</h3>
                                          <p class="text-sm text-gray-900">{{ purchase.order_date | date:"j M y" }}</p>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                              <!-- Items Table -->
                              <div class="p-8">
                                 <table class="w-full">
                                    <thead>
                                       <tr class="border-b border-gray-200">
                                          <th class="text-left pr-3 py-3 text-sm font-medium text-gray-600 uppercase tracking-wide">item name</th>
                                          <th class="text-right px-3 py-3 text-sm font-medium text-gray-600 uppercase tracking-wide">ordered</th>
                                          <th class="text-right px-3 py-3 text-sm font-medium text-gray-600 uppercase tracking-wide">Received</th>
                                          <th class="text-left px-3 py-3 text-sm font-medium text-gray-600 uppercase tracking-wide">status</th>
                                          <th class="text-right px-3 py-3 text-sm font-medium text-gray-600 uppercase tracking-wide">RATE</th>
                                          <th class="text-right pl-3 py-3 text-sm font-medium text-gray-600 uppercase tracking-wide">AMOUNT</th>
                                       </tr>
                                    </thead>
                                    <tbody>
                                       {% for item in purchase.po_items.all %}
                                          <tr class="border-b border-gray-100">
                                             <td class="pr-4 py-4">
                                                <p class="text-sm font-medium text-blue-600">{{ item.product.modelname | upper }}</p>
                                             </td>
                                             <td class="text-right px-4 py-4">
                                                <p class="text-sm text-right text-gray-900">{{ item.ordered_quantity }}</p>
                                             </td>
                                             <td class="text-right px-4 py-4">
                                                <p class="text-sm text-gray-900">{{ item.received_quantity }}</p>
                                             </td>
                                             <td class="px-4 py-4">
                                                <p class="text-sm text-gray-900 {{ item.status | status_color }}">{{ item.status | title }}</p>
                                             </td>
                                             <td class="px-4 py-4 text-right">
                                                <p class="text-sm text-gray-900">NGN {{ item.unit_price_at_order | floatformat:"2g" }}</p>
                                             </td>
                                             <td class="pl-4 py-4 text-right">
                                                <p class="text-sm text-gray-900">NGN {{ item.total_price | floatformat:"2g" }}</p>
                                             </td>
                                          </tr>
                                       {% endfor %}
                                    </tbody>
                                 </table>
                                 <!-- Totals Section -->
                                 <div class="mt-8 flex justify-end">
                                    <div class="w-80">
                                       <div class="flex justify-between items-center py-2 text-xs text-gray-500">
                                          <span>Total Quantity - {{ purchase.total_ordered }}</span>
                                          <span></span>
                                       </div>
                                       <div class="flex justify-between items-center py-3 border-t-2 border-gray-300 mt-2">
                                          <span class="text-lg font-semibold text-gray-900">Total</span>
                                          <span class="text-lg font-semibold text-gray-900">NGN {{ purchase.total_amount | floatformat:"2g" }}</span>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  {% endblock _content %}
               {% endblock main_content %}
            </div>
         </div>
      </div>
   </div>
{% endblock content %}
